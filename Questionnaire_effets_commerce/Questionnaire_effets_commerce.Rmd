---
subtitle: "Analyse des résultats d'une enquête sur les effets du commerce de proximité "
title: "![](images/Logo_excom_complet.png){width=20%} Projet EXCOM"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      theme: paper
      toc: true
      toc_float: true
      toc_depth: 5
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(eval = TRUE,
                      echo = FALSE,
                      fig.align = "center",
                      fig.show = "hold",
                      message = FALSE,
                      warning = FALSE,
                      collapse = TRUE,
                      results = 'asis',  # pour un dfSummary propre
                      out.width = "70%")
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "images/logos_partenaires.png", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

Les commerces ne sont pas de stricts acteurs économiques, dont la valeur sociale serait équivalente à la valeur marchande. Cette intuition est largement partagée dans les espaces politiques, académiques ou encore économiques.

Ce postulat central à notre projet commence à s’intégrer dans les politiques publiques. Le soutien
aux commerçants est en effet perçu comme un levier de l’action publique pour redynamiser les
centres urbains. La vitalité commerciale est ainsi un axe central du plan national Action cœur de
ville, qui réaffirme l’importance des centres-villes, notamment ceux des villes moyennes, dans le
paysage territorial.

Pourtant, les effets du commerce sont encore mal identifiés, et les quelques travaux
académiques ou produits par des experts se concentrent quasi exclusivement sur leur
rôle d’entretien du vivre ensemble, ou sur leurs externalités négatives (par exemple leur
rôle dans les processus de gentrification).
En conséquence, les effets dans leur globalité sont peu, voire pas visibilisés ni quantifiés.

Le **projet de recherche-action EXCOM** a pour objectif de combler ce manque en nommant
et en mesurant ces effets, étape essentielle pour repenser la valeur globale du commerce.

Il s’inscrit au croisement des questionnements de cinq partenaires : la SEM Paris
Commerce, la Métropole Rouen Normandie, la fondation Urbanis, Altavia Foundation,
Datactivist.

<p align="center">
 <img src="images/Roue_externalites_verte.png" width = "500">
</p>


# Import des données


```{r}
# Librairies
library(tidyverse)
library(readxl)
library(esquisse)
library(gt)
library(gtExtras)
library(janitor)
library(reactable)
library(DT)
library(plotly)
library(ggVennDiagram) #devtools::install_github("gaospecial/ggVennDiagram")
library(ggwordcloud)
library(tm)
library(emojifont)

# Données
raw_data <- read_csv("data/[Fillout] EXCOM _ Enquête sur les effets du commerce de proximité results.csv")
repartition_theorique <- read_excel("data/Repartition_theorique_repondants.xlsx")
  # identifiant des départements
departements_dg <- read_csv("https://www.data.gouv.fr/fr/datasets/r/67432189-8426-42e6-9ddb-8d21631df9c5")
  # OFGL - données de population
communes_pop <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-communes-consolidee/exports/csv?lang=fr&refine=exer%3A%222023%22&refine=agregat%3A%22Achats%20et%20charges%20externes%22&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
  rename(cog_commune = `Code Insee 2023 Commune`,
         nom_commune = `Nom 2023 Commune`,
         population = `Population totale`) |> 
  select(cog_commune, nom_commune, population)
  # Datagouv - codes postaux : https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/
codes_postaux_dg <- read_csv("data/codes_postaux_datagouv.csv") |>
  select(-Ligne_5) |> distinct() |> 
  mutate(Code_commune_INSEE = ifelse(nchar(Code_commune_INSEE) == 4, paste0("0", Code_commune_INSEE), Code_commune_INSEE),
         Code_postal = ifelse(nchar(Code_postal) == 4, paste0("0", Code_postal), Code_postal)) |> 
    #jointure sur le COG
  left_join(communes_pop |> select(-nom_commune), by = c("Code_commune_INSEE" = "cog_commune")) |> 
    #jointure sur le nom de commune pour les ligne snon matchées
  left_join(communes_pop |> 
              select(-cog_commune) |> 
              mutate(nom_commune = stringi::stri_trans_general(str = gsub("-", " ", toupper(nom_commune)), id = "Latin-ASCII")),
            by = c("Libelle_acheminement" = "nom_commune")) |> 
  filter(population.x == population.y | is.na(population.x) | is.na(population.y)) |> 
  mutate(population = coalesce(population.x, population.y)) |> 
  select(-c(population.x, population.y))

a <- n_distinct(raw_data$`Quel est le nom de votre commerce ?`)
```

Diffusée à partir du 4 avril 2024, l'enquête sur les effets du commerce de proximité vise à rendre visible l'impact de l'activité commerciale sur le quartier, la ville et ses habitants.

Composée de près de 40 questions, l'enquête se divise en 6 sections reprenant les grandes catégories d'externalités identifiées dans la première phase du [projet de recherche-action EXCOM](https://projet-excom.fr/) :

- Lien Social ;
- Solidarités ;
- Vie de quartier ;
- Santé et Sécurité ;
- Environnement ;
- Espace public.

Au `r format(Sys.time(), '%d %B %Y')`, `r a` réponses uniques ont été récoltées.


## Aperçu des données{.tabset}

```{r}
# Nom des colonnes
noms_cols <- names(raw_data) |> as.data.frame()

# Nettoyage / mise en qualité / création de nouvelles variables
data <- raw_data |> 
    # Extraction code postal de l'adresse
  rowwise() |> 
  mutate(`Quelle est l'adresse de votre commerce ?` = ifelse(`Quelle est l'adresse de votre commerce ?` == "\n  \n", NA, `Quelle est l'adresse de votre commerce ?`),
         adresses = coalesce(`Quelle est l'adresse de votre commerce ?`, 
                             as.character(`Dans quelle ville intervenez-vous le plus régulièrement ? (Renseigner le code postal)`),
                             as.character(`Dans quelle ville travaillez-vous le plus régulièrement ? (Renseigner le code postal)`)),
         adresses = str_replace_all(adresses, "\\b(\\d{2}) (\\d{3})\\b", "\\1\\2"), #formattage zip code mal renseigné
         zip_code = str_extract(adresses, "\\d{5}"),
         code_departement = substr(zip_code, 1, 2)) |> 
  left_join(departements_dg |> select(nom, COG, code_region), by = c("code_departement" = "COG")) |> 
  rename(nom_departement = nom) |> 
  mutate(nom_departement_partenaires = case_when(!code_departement %in% c("75", "76", "13", "41") ~ "Autres",
                                                 .default = nom_departement),
         code_departement_partenaires = case_when(!code_departement %in% c("75", "76", "13", "41") ~ "Autres",
                                                 .default = code_departement)) |> 
  ungroup() |> 
    # Nettoyage des variables 
  mutate_all(~str_squish(.)) |> #remove non necessary spaces
  mutate(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)` = ifelse(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)` == "Très rarement (moins d'une fois par semaine)", "Très rarement (moins d'une fois par mois)", `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> #correction erreur dans la catégorie 'Très rarement'
    # Création de variables catégorielles à partir des variables existantes
      ## Ce que propose le commerce
  mutate(is_services = case_when(grepl("Des services", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0"),
         is_biens_propres = case_when(grepl("Des produits fabriqués ou élaborés par moi(nous)-même(s)", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0"),
         is_biens_dautres = case_when(grepl("Des produits fabriqués ou élaborés par d'autres", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0")) |>
      ## Fréquentation du commerce
  mutate(frequentation_commerce = case_match(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`,
                                             "50 à 100" ~ "Plus de 50",
                                             "100 et 200" ~ "Plus de 50",
                                             "Plus de 200" ~ "Plus de 50",
                                             .default = `Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`)) |> 
      ## Collaboration avec des associations
  mutate(collab_asso = case_when(grepl("Oui", `Collaborez-vous avec des associations locales ? Par exemple des associations de quartier ou d'aide humanitaire.(Plusieurs réponses sont possibles)`) == TRUE ~ "Oui",
                                 `Collaborez-vous avec des associations locales ? Par exemple des associations de quartier ou d'aide humanitaire.(Plusieurs réponses sont possibles)` == "Je n'ai pas l'habitude de collaborer avec des associations" ~ "Non",
                                 .default = NA_character_)) |> 
      ## Aide aux autres commerçants
  mutate(aide_commercants = case_when(grepl("Je connais les autres commerçants mais je n'ai pas l'occasion de rendre ces services", `L'entraide entre commerçants permet de faire face à des difficultés et constitue un réseau d'échange de services. Quels services avez-vous l'habitude de rendre à vos collègues commerçants ? (Plusieurs réponses sont possibles)`) == TRUE ~ "Non",
                                      .default = "Oui")) |> 
    # Enrichissement de la population
  mutate(zip_code_general = case_when(zip_code == "13000" ~ "13001",
                                       zip_code == "75000" ~ "75001",
                                       .default = zip_code)) |> 
  left_join(codes_postaux_dg, by = c("zip_code_general" = "Code_postal")) |> 
  arrange(desc(population), .by = `Quel est le nom de votre commerce ?`) |> 
  slice(1, .by = `Quel est le nom de votre commerce ?`) |> #qd match avec plusieurs codes postaux, on garde seulement la ville avec la population la plus élevée
  mutate(categorie_population = case_when(population < 1000 ~ "population faible",
                                          population >= 1000 & population < 10000 ~ "population moyenne",
                                          population >= 10000 & population < 100000 ~ "population élevée",
                                          population >= 100000 ~ "population très élevée",
                                          .default = NA_character_))


# Filtre sur l'Ile de France
idf <- data |> 
  filter(code_region == "11") # ile de france
rio::export(idf, "data/export_reponses_idf.csv")

# Filtre sur PAris
paris <- data |> 
  filter(Libelle_acheminement == "PARIS") |> 
  select(`Quel est le nom de votre commerce ?`, adresses, zip_code, Nom_de_la_commune)
rio::export(paris, "data/export_commerces_paris.csv")


# Nom des colonnes
noms_cols_data <- names(data) |> as.data.frame()
```



```{r}
# Calcul de la répartition de notre échantillon
repartition_reelle <- data |> 
  summarise(`Échantillon réel de l'enquête` = n(), .by = code_departement_partenaires) |> 
  right_join(repartition_theorique |> mutate(`Code département` = as.character(`Code département`)), 
             by = c("code_departement_partenaires" = "Code département")) |> 
  relocate(code_departement_partenaires, .after = Ville) |> 
  relocate(`Échantillon réel de l'enquête`, .after = `Échantillon théorique de l’enquête`) |> 
  arrange(code_departement_partenaires) |> 
  mutate(`Répartition des commerces français` = round(`Répartition des commerces français`, 1),
         `Échantillon théorique de l’enquête` = round(`Échantillon théorique de l’enquête`, 0),
         `Échantillon réel de l'enquête` = replace_na(`Échantillon réel de l'enquête`, 0),
         `Répartition de l'échantillon réel` = round(`Échantillon réel de l'enquête` / sum(`Échantillon réel de l'enquête`) * 100, 1)) |> 
  adorn_totals() |> 
  mutate(`% de l'objectif de réponses atteint` = round(`Échantillon réel de l'enquête` / `Échantillon théorique de l’enquête` * 100, 0),
         `% de l'objectif de réponses atteint` = replace_na(`% de l'objectif de réponses atteint`, 0)) |> 
  mutate(across(-c(Ville, code_departement_partenaires), ~ if_else(Ville == "Total", round(., 0), .))) |> 
  mutate(`Répartition des commerces français` = paste0(`Répartition des commerces français`, "%"),
         `Répartition de l'échantillon réel` = paste0(`Répartition de l'échantillon réel`, "%")) |> 
  mutate_at(vars(-`% de l'objectif de réponses atteint`), as.character) |> 
  mutate_at(vars(-`% de l'objectif de réponses atteint`), ~replace_na(., "")) |> 
  rename(`Code département` = code_departement_partenaires) |> 
  arrange(`Échantillon réel de l'enquête`)

# Affichage de la table
repartition_reelle |> 
  gt() |>
  gt_theme_nytimes() |> 
  tab_header(title = "Répartition des réponses à l'enquête par département") |>
  tab_style(style = list(cell_text(weight = "bold")), #en gras
    locations = cells_body(columns = `Échantillon théorique de l’enquête`)) |> 
  cols_align(align = "center", columns = everything()) |> 
  cols_align(align = "left", columns = Ville) |> 
  gt_plt_bar_pct(`% de l'objectif de réponses atteint`, scaled = TRUE, labels=TRUE, decimals = 0, #attention à remplacer les NA par 0 sinon erreur
           font_size = "14px", fill = "#00F193", height = 20)
```

<br>

### Départements "Autres"

**Les départements "Autres" sont les suivants :**

```{r}
# Départements "Autres"
table <- data |> 
  filter(code_departement_partenaires == "Autres") |> 
  summarise(`Nombre de commerces` = n(), .by = nom_departement) |> 
  arrange(desc(`Nombre de commerces`)) |> 
  rename(Département = nom_departement)
# Affichage des données
datatable(table, options = list(pageLength = 10))
```

### Détail Métropole de Rouen

**Au sein de la métropole de Rouen, les réponses se répartissent de la manière suivante :**

```{r}
table <- data |> 
    filter(code_departement_partenaires == 76 & Nom_de_la_commune != "EU") |> 
    summarise(`Nombre de réponses` = n(), .by = Nom_de_la_commune) |> 
    arrange(desc(`Nombre de réponses`)) |> 
    rename(Commune = Nom_de_la_commune)
datatable(table)
```


## Traitement des données

Quelques manipulations ont été faites sur les données en amont de leur analyse, pour les enrichir ou corriger leur qualité. Ces changements sont documentés ci-dessous : 

- **Extraction du code postal depuis l'adresse** :
  - rassemblement des questions *Quelle est l'adresse de votre commerce ?* et *Dans quelle ville intervenez-vous le plus régulièrement ? (Renseigner le code postal)* en une variable
  - extraction du code postal (5 chiffres) depuis cette nouvelle variable
  - extraction du code du département ; 2 premiers chiffres du code postal
  - récupération du nom du département et de la région à partir des données externes datagouv [*Identifiants des collectivités territoriales et leurs établissements*](https://www.data.gouv.fr/fr/datasets/identifiants-des-collectivites-territoriales-et-leurs-etablissements/)
- **Création ou regroupement de catégories à partir des variables existantes** : 
  - *Que propose votre commerce ? (Plusieurs réponses sont possibles)*
  - *Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)*
  - *Collaborez-vous avec des associations locales ? Par exemple des associations de quartier ou d'aide humanitaire.(Plusieurs réponses sont possibles)*
  - *L'entraide entre commerçants permet de faire face à des difficultés et constitue un réseau d'échange de services. Quels services avez-vous l'habitude de rendre à vos collègues commerçants ? (Plusieurs réponses sont possibles)*
- **Enrichissement de la population** :
  - jointure de codes postaux extraits des adresses avec les données externes datagouv [*Base officielle des codes postaux*](https://www.data.gouv.fr/fr/datasets/base-officielle-des-codes-postaux/) dans lesquelles apparaissent les données de population
  - gestion des communes multiples avec un même code postal : il a été décidé de garder la commune avec la population la plus élevée
  - création d'une nouvelle variable de la catégorie de population avec 4 niveaux : faible, moyenne, élevée, très élevée.
  
Les tranches de population sont les suivantes :

- '***population faible***' correspond aux villes dont la population est inférieure à 1.000 habitants, soit `r data |> filter(categorie_population == "population faible") |> nrow()` communes ;
- '***population moyenne***' correspond aux villes dont la population est comprise entre 1.000 et 9.999 habitants, soit `r data |> filter(categorie_population == "population moyenne") |> nrow()` communes;
- '***population élevée***' correspond aux villes dont la population est comprise entre 10.000 et 99.999 habitants, soit `r data |> filter(categorie_population == "population élevée") |> nrow()` communes;
- '***population très élevée***' correspond aux villes dont la population est supérieure ou égale à 100.000 habitants, soit `r data |> filter(categorie_population == "population très élevée") |> nrow()` communes.



# Aperçu des données

```{r}
# Thème pour les graphs
font <- "Open Sans"
custom_theme <- function (){
    font <- "Open Sans"
    ggplot2::theme(plot.title = ggplot2::element_text(family = font,size = 21, face = "bold", color = "#222222"), 
        plot.subtitle = ggplot2::element_text(family = font,size = 18, face = "italic", margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(family = font,size = 18, margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.title = ggplot2::element_text(family = font, size = 18, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(family = font, size = 15,color = "#222222"), 
        axis.text = ggplot2::element_text(family = font, size = 15,color = "#222222"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text(family = font, size = 18,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 22, hjust = 0, face = "bold"))
}

# Premier graphique
ggplot(raw_data) +
  aes(x = `Quelle est la catégorie de votre commerce ?`) +
  geom_bar(fill = "#0C4C8A") +
  labs(
    y = "Nombre de commerces",
    title = "Catégorie des commerces répondants"
  ) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank())
```

<br>

```{r}
raw_data |> 
  mutate(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)` = 
           factor(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`,
                  levels = c("1 à 20", "20 à 50", "50 à 100", "100 et 200", "Plus de 200"))) |> 
  filter(!is.na(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`)) |> 
  ggplot() +
    aes(
      x = `Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`
    ) +
    geom_bar(fill = "#0C4C8A") +
    labs(
      y = "Nombre de commerces", 
      x = "Fréquentation moyenne du commerce par jour",
      title = "Fréquentation des commerces répondants"
    ) +
    theme_minimal() +
    custom_theme()
```

<br>

```{r}
data |> 
  mutate(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?` = factor(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
  select(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  na.omit() |> 
  ggplot() +
  aes(
    x = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`
  ) +
  geom_bar(fill = "#0C4C8A") +
  labs(
    x = "Fréquence",
    y = "Nombre de commerces",
    title = str_wrap("Fréquence d'échange sur des sujets privés avec les clients", width = 45)
  ) +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
  coord_flip() +
  theme_minimal() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()) +
  custom_theme()
```


<br>

```{r}
# Table
table <- data |> 
  summarise(nb= n(), .by = `Êtes-vous indépendant ?`) |> na.omit() |> 
  mutate(Pourcentage = round(nb / sum(nb) * 100, 0)) |> 
  mutate(ypos = cumsum(Pourcentage) - .9 * Pourcentage, .by = `Êtes-vous indépendant ?`)

# Dataviz
table |> 
    ggplot(aes(x="", y=nb, fill=`Êtes-vous indépendant ?`)) +  
      geom_bar(stat="identity", width=1, color="white", size = 2) +
      coord_polar("y") +
      scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
      labs(title = str_wrap("Répartition des commerces répondants selon s'ils sont indépendants ou non", width = 35)) +
      theme_classic() + 
      theme(legend.position = "top",
            strip.text.x = element_text(size = 12, face = "bold"),
            strip.background = element_blank(),
            axis.title = element_blank(),
            axis.ticks = element_blank(),
            axis.line = element_blank(),
            axis.text = element_blank(),
            legend.text = ggplot2::element_text(size = 18,color = "#222222"), 
            text = element_text(family = "Montserrat", size = 12),
            plot.title = ggplot2::element_text(size = 19, face = "bold", color = "#222222"), 
            plot.caption = ggplot2::element_text(face = "italic", size = 18, 
                                                 color = "#666666", margin = ggplot2::margin(9, 0, 9, 0)), 
            plot.title.position = "plot", 
            plot.caption.position = "plot") +
      guides(fill = guide_legend(reverse = F, title = " ")) +
      geom_text(aes(y = ypos, x = 2, label = paste(round(Pourcentage,0), "%", sep="")), color = "#333333", size=5, check_overlap = T)
```


<br>

```{r fig.width=9}
# Transformation des données pour le graph
table <- data |> 
  select(`Que propose votre commerce ? (Plusieurs réponses sont possibles)`) |> 
  mutate(id = row_number(),
         Services = case_when(grepl("Des services", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_),
         `Biens \npropres` = case_when(grepl("par moi", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_),
         `Biens d'autres` = case_when(grepl("Des produits fabriqués ou élaborés par d'autres", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_)) |> 
  select(Services, `Biens \npropres`, `Biens d'autres`) |> 
  as.list()

# Graph
ggVennDiagram(table, label_alpha = 0) + 
  labs(title = "Ce que vendent les commerces répondants", subtitle = " ") +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  guides(fill = guide_legend(title = "Nombre de \ncommerces")) + 
  theme(legend.position = "top",
        strip.text.x = element_text(size = 12, face = "bold"),
        strip.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        legend.text = ggplot2::element_text(size = 18,color = "#222222"), 
        text = element_text(family = "Montserrat", size = 12),
        plot.title = ggplot2::element_text(size = 17, face = "bold", color = "#222222"), 
        plot.caption = ggplot2::element_text(face = "italic", size = 18, 
                                             color = "#666666", margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot", 
        plot.caption.position = "plot")
```

<br>

```{r include=FALSE}
# Data
data_wordcloud <- data |> 
  filter(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)` != "Je n'ai pas l'habitude de proposer quelque chose") |> 
  mutate(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)` = str_replace_all(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)`, ",", " ")) |> 
  glimpse()
corpus = Corpus(VectorSource(data_wordcloud$`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)`))
    # mise en forme des mots
corpus = tm_map(corpus, PlainTextDocument) #Conversion to Lowercase
corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation) #Removing Punctuation
    # retrait des mots non désirés (pronoms, auxiliaires etc.)
corpus = tm_map(corpus, removeWords, c("cloth", stopwords("french"))) #Remove stopwords
corpus = tm_map(corpus, stripWhitespace) # Eliminate white spaces
    # bon format du df
DTM <- TermDocumentMatrix(corpus)
mat <- as.matrix(DTM)
f <- sort(rowSums(mat),decreasing=TRUE) 
word_data <- data.frame(word = names(f),freq=f)
```

```{r}
# Viz
word_data |> 
  ggplot(aes(label = word, size = freq)) +
      geom_text_wordcloud(color = rep_len(c('#afc7de','#9ecae1', "#3081bc"), nrow(word_data)), family = "Montserrat") +
      scale_size_area(max_size = 18) +
      labs(title = str_wrap("Aides proposées par les commerces aux personnes en situation de précarité", width = 45)) +
      theme_minimal() +
      theme(plot.title = ggplot2::element_text(family = font,size = 21, face = "bold", color = "#222222"),
            plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))

```

<br>




```{r eval=FALSE, include=FALSE}
data |> 
  filter(!is.na(`Utilisez-vous des techniques traditionnelles et/ou artisanales pour fabriquer vos produits ?`) &
             !is.na(`Dans certains cas, vous pouvez être susceptible d'organiser, à l'intérieur de votre magasin, des séances d'information, démonstrations ou ateliers (explications approfondies d'utilisation de vos produits, transmission de connaissances, etc.).Combien en organisez-vous par an ? (Si vous n'en organisez aucune, mettre '0')`)) |> 
  ggplot() +
  aes(
    x = as.numeric(`Dans certains cas, vous pouvez être susceptible d'organiser, à l'intérieur de votre magasin, des séances d'information, démonstrations ou ateliers (explications approfondies d'utilisation de vos produits, transmission de connaissances, etc.).Combien en organisez-vous par an ? (Si vous n'en organisez aucune, mettre '0')`),
    #group = `Utilisez-vous des techniques traditionnelles et/ou artisanales pour fabriquer vos produits ?`
  ) +
  geom_curve(fill = "#0C4C8A") +
  labs(
    x = "Nombre d'évènements organisés",
    y = "Utilisation de techniques \ntraditionnelles ou artisanales",
    title = str_wrap("Nombre d'évènements organisés dans le commerce selon l'utilisation de techniques traditionnelles ou artisanales", width = 45)
  ) +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()) 
```



```{r}
# Data
table <- data |> 
  mutate(`Où vendez-vous vos produits / services ?` = str_replace_all(`Où vendez-vous vos produits / services ?`, 
                                                                      c("Dans un lieu de vente à durée limitée / non fixe" = "Lieu de vente non fixe",
                                                                        "Dans un lieu de vente permanent / fixe" = "Lieu de vente fixe",
                                                                        "Je n'ai pas d'espace dédié \\(déplacements à domicile ou présence en ligne uniquement\\)" = "Pas d'espace dédié")))

# Stats
stats_lieu <- table |> 
  summarise(n = n(), .by = `Où vendez-vous vos produits / services ?`) |> 
  na.omit() |> 
  arrange(`Où vendez-vous vos produits / services ?`)

# Viz
table |> 
  filter(!is.na(`Êtes-vous indépendant ?`)) |> 
  summarise(n=n(), .by = c(`Où vendez-vous vos produits / services ?`, `Êtes-vous indépendant ?`)) |> 
  mutate(percent = round(n/sum(n), 2), .by = `Où vendez-vous vos produits / services ?`) |> 
  ggplot() +
  aes(
    x = `Où vendez-vous vos produits / services ?`,
    y = percent,
    fill = `Êtes-vous indépendant ?`
  ) +
  geom_col() +
  scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  labs(
    x = "Lieu de vente",
    y = "Pourcentage des commerces",
    title = "Lieu de vente des commerces selon leur \nindépendance",
    subtitle = str_wrap(paste("Répartition des commerces de l'échantillon :", stats_lieu[1,2], "en lieu fixe,", stats_lieu[2,2], "en lieu non fixe,", stats_lieu[3,2], "sans espace dédié"), width = 55),
    fill = "Indépendance"
  ) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))
```


# ![](images/lien_social.png){width=11%}  <FONT COLOR="#B4B1B1">Lien social</FONT>


## <FONT COLOR="#B4B1B1">Socialiser & réduire l'isolement</FONT>



### <FONT COLOR="#B4B1B1">Chiffres clés</FONT>

```{r out.width = '100%'}
# Fonction pour les inforgraphies
infographie_graph <- function(valeur1, texte1, icone1, valeur2, texte2, icone2, valeur3, texte3, icone3){
    # Données
    df <- data.frame(
        x = c(2, 2, 2),
        y = c(2, 6.5, 11),
        h = rep(4.25, 3),
        w = rep(18, 3),
        value = c(valeur1, valeur2, valeur3),
        info = c(texte1, texte2, texte3),
        icon = c(fontawesome(icone1), fontawesome(icone2), fontawesome(icone3)),
        font_family = c(rep("fontawesome-webfont", 3)),
        color = factor(1:3))
    
    # Graph
    ggplot(df, aes(x, y, height = h, width = w, label = info)) +
        ## Create the tiles using the `color` column
        geom_tile(aes(fill = color)) +
        ## Add the numeric values as text in `value` column
        geom_text(color = c("1" = "white", "2" = "black", "3" = "white"), fontface = "bold", size = 23,
                  aes(label = value, x = x - 4, y = y + 1), hjust = 0) +
        ## Add the labels for each box stored in the `info` column
        geom_text(color = c("1" = "white", "2" = "black", "3" = "white"), fontface = "bold", size = 8,
                  aes(label = str_wrap(info, width = 55), x = x - 4, y = y - .8), hjust = 0, lineheight = 0.6) +
        coord_fixed() +
        scale_fill_brewer(type = "qual",palette = "Dark2") +
        ## Use `geom_text()` to add the icons by specifying the unicode symbol.
        geom_text(size = 45, aes(label = icon, family = font_family,
                                 x = -4.5, y = y + 0.5), alpha = 0.25) +
        # Couleurs
        scale_fill_manual(values = c("1" = "#465FA5", "2" = "#E6E6E6", "3" = "#85BF8F")) +
        # Titre et thème
        labs(title = "       Dans l'échantillon de répondants :") +
        theme_void() +
        theme(plot.title = element_text(family = font, size = 21, face = "bold", color = "#222222")) +
        guides(fill = FALSE)
}

# Données
    # boxe 1
val1 <- paste0(round((1 - ((data |> 
    count(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
    na.omit() |> 
    rename(Var = 1) |> 
    mutate(percent = n/sum(n)) |> 
    filter(Var == "Jamais") |> 
    select(percent))$percent)) * 100, 0), "%")
    # boxe 2
        #pre-run stats graph général + IDF et jointure
table <- data |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_discussions <- table |> select(-n) |> rename(percent_ref = percent)
val2 <- idf |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1) |> 
  left_join(ref_discussions, by = "Var") |> 
  mutate(n_ref = percent_ref/100 * sum(n),
         ecart = round((percent - percent_ref), 0),
         ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
  filter(Var == "Très régulièrement (plusieurs fois par jour)") |> 
  mutate(ratio = round(percent_ref/percent, 1))
    
# Application de la fonction
infographie_graph(val1, "des commerces ont des discussiones privées avec leurs clients", 'fa-comments',
                  val2$ratio, paste("Les commerçants d'Ile-de-France discutent", val2$ratio, "fois moins très régulièrement (plusieurs fois par jour) avec leurs clients que l'ensemble des commerçants"), 'fa-building',
                 "< 0.5", "target pvalue", 'fa-globe')
```


**Question posée dans l'enquête :** "*Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?*".


<br>

```{r fig.height=7, fig.width=10}
# Data
table <- data |> 
    filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  summarise(n= n(), .by = c(nom_departement_partenaires, `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?` = factor(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) 

# Viz
table |> 
  ggplot(aes(x=nom_departement_partenaires, y=`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, fill=n)) + 
    geom_tile() +
    theme_classic() +
    guides(fill = guide_legend(title = "Nombre de commerces", reverse = F)) +
    scale_fill_gradient(low = "#c7d9e8", high = "steelblue", 
                        limits = c(floor(min(table$n)), ceiling(max(table$n))),
                        breaks = round(seq(floor(min(table$n)), ceiling(max(table$n)), length.out = 4))) +
    labs(title = "Échange sur des sujets privés avec les clients selon le territoire", y = "Fréquence des échanges") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    custom_theme()
#ggplotly(graph)
```


### <FONT COLOR="#B4B1B1">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Graphique factorisé
graph_questions_freq <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Je ne sais pas", "Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre de commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top",
              panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
              panel.grid.major.y = ggplot2::element_blank()) +
        guides(alpha = "none") +
        coord_flip()
}

# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_discussions <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 12, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+12, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```

#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "En Ile-de-France, les commerçants discutent moins de sujet privés avec leurs clients que les commerçants de l'ensemble du territoire", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "Très rarement (moins d'une fois par mois)", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 3, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Graphique factorisé
graph_comparaison_pop <- function(data, subtitle_name){
  data |> 
    mutate(nb_reponses_freq = sum(n), .by = Var) |> 
    mutate(Var = factor(Var, levels = c("Je ne sais pas", "Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)")),
           categorie_population = factor(categorie_population, levels = c("faible", "moyenne", "élevée", "très élevée"))) |> 
    ggplot() + 
    geom_bar(aes(y=percent_freq, x=Var, fill = categorie_population, group = categorie_population, alpha = Var != ""),
             position="stack", stat="identity", width=.6) +
    geom_text(aes(label = paste(nb_reponses_freq, ifelse(nb_reponses_freq <= 1, "réponse", "réponses")), x=Var, fill = categorie_population, group = categorie_population, y = 0.01), 
              hjust = 0, color = "white", fontface = "italic", size = 5) +
    scale_fill_manual(values = c("faible" = "#DEEBF7", "moyenne" = "#9ECAE1", "élevée" = "#3182BD", "très élevée" = "#0C4C8A")) +
    scale_alpha_manual(values=c(1, .4)) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
    scale_y_continuous(labels = scales::percent, limits = c(0,1)) + # pourcentages
    labs(x = "", y = "Pourcentage des commerces", linetype = "",
         subtitle = stringr::str_wrap(subtitle_name, width = 55),
         title = stringr::str_wrap("Comparaison des communes selon leur population", width = 50)) +
    theme_classic() +
    custom_theme() +
    theme(legend.position = "top",
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank()) +
    guides(alpha = "none", fill = guide_legend(title = "Population", nrow = 2, reverse = TRUE)) +
    coord_flip()
}

# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon leurs discussions privées avec des clients")
```

### <FONT COLOR="#B4B1B1">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Graphique factorisé
graph_type_commerce_freq_agregee <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Moins d'1 fois par semaine", "1 fois par semaine et plus"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre de commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top") +
        guides(alpha = "none")
}

# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```


```{r eval=FALSE, fig.height=7, include=FALSE}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Commerces et services de véhicules automobiles") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la vente et services de véhicules automobiles", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```

#### Comparaison

```{r fig.height=9, fig.width=12}
# Graphique factorisé
graph_type_commerce_comparaison <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart)), 
               percent_ref = percent_ref/100,
               .by = `Quelle est la catégorie de votre commerce ?`) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Moins d'1 fois par semaine", "1 fois par semaine et plus"))) |> 
        ggplot() + 
        geom_bar(aes(y=percent, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=percent_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) + #axis-text trop longs sur plusieurs lignes
        scale_y_continuous(labels = scales::percent, limits = c(0,1)) + # pourcentages
        labs(x = "", y = "Pourcentage des commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 100),
             title = stringr::str_wrap(title_name, width = 100)) +
        facet_wrap(~`Quelle est la catégorie de votre commerce ?`) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top",
              strip.text = ggplot2::element_text(size = 15)) +
        guides(alpha = "none")
}

# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions privées avec des clients", 1, "", "#3182bd")
```



## <FONT COLOR="#B4B1B1">Partager des savoir-faire</FONT>

**Question posée dans l'enquête :** "*À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.*".

### <FONT COLOR="#B4B1B1">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_explications_produits <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Ile-de-France", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 3, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 3, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`) |> 
  filter(!is.na(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_explications_produits, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 5, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients")
```

### <FONT COLOR="#B4B1B1">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```



#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`À quelle fréquence donnez-vous des explications approfondies sur vos produits à vos clients ? Cela peut aussi concerner des démonstrations.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon la fréquence d'explications sur les produits avec des clients", 1, "", "#3182bd")
```




## <FONT COLOR="#B4B1B1">Construire une communauté locale</FONT>


# ![](images/solidarites.png){width=11%}  <FONT COLOR="#004654">Solidarités</FONT>



## <FONT COLOR="#004654">Aider les personnes précaires</FONT>

**Question posée dans l'enquête :** "*Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.*".

### <FONT COLOR="#004654">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_sollicitations_precaires <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Ensemble des commerces", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Ile-de-France", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`) |> 
  filter(!is.na(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_sollicitations_precaires, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon les sollicitations par des personnes en situation de précarité")
```

### <FONT COLOR="#004654">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général


```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Etes-vous sollicité par des personnes en situation de précarité dans le cadre de votre activité commerciale ?Cela peut être pour un café, de l'eau ou pour utiliser des toilettes.`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon les sollicitations par des personnes en situation de précarité", 1, "", "#3182bd")
```



## <FONT COLOR="#004654">Prendre soin des gens</FONT>

**Question posée dans l'enquête :** "*Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)*".

<br>

```{r fig.height=5}
# Stats
stats_discu_info <- data |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  na.omit() |> 
  arrange(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)

# Data
table <- data |> 
  filter(!is.na(frequentation_commerce),
         `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)` != "Je ne sais pas") |> 
  summarise(n=n(), .by = c(frequentation_commerce, `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = round(n/sum(n), 4), .by =`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  mutate(discu_nb_commerces = case_match(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                                         "Très rarement (moins d'une fois par mois)" ~ paste0("Moins d'une fois par mois \n(", stats_discu_info[5,2], " commerces)"), 
                                         "Rarement (1 à 2 fois par mois)" ~ paste0("1 à 2 fois par mois \n(", stats_discu_info[3,2], " commerces)"), 
                                         "Ponctuellement (1 à 2 fois par semaine)" ~ paste0("1 à 2 fois par semaine \n(", stats_discu_info[2,2], " commerces)"), 
                                         "Régulièrement (3 à 5 fois par semaine)" ~ paste0("3 à 5 fois par semaine \n(", stats_discu_info[4,2], " commerces)"), 
                                         "Très régulièrement (plusieurs fois par jour)" ~ paste0("Plusieurs fois par jour \n(", stats_discu_info[6,2], " commerces)"), 
                                         .default = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`))

# Viz
table |> 
  mutate(discu_nb_commerces = factor(discu_nb_commerces, 
                                     levels = table |> 
                                       distinct(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, discu_nb_commerces) %>%
                                       arrange(factor(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                                                      levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
                                       pull(discu_nb_commerces))) |> 
  ggplot() +
    aes(x = discu_nb_commerces, fill = frequentation_commerce, y = percent) +
    geom_col() +
    scale_fill_brewer(palette = "Blues", direction = 1) +
    scale_y_continuous(labels = scales::percent, limits = c(0,1.01)) +
    labs(
      x = "Fréquence des \ndiscussions informelles",
      y = "Nombre de commerces",
      title = str_wrap("Fréquence des discussions informelles avec les clients selon le nombre de visites quotidiennes", width = 50),
      fill = "Fréquentation \ndu commerce"
    ) +
    coord_flip() +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.y = element_text(size = 11L),
      axis.text.x = element_text(size = 11L)
    ) +
    custom_theme() +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.y = ggplot2::element_blank()) +
    guides(fill = guide_legend(nrow = 3, byrow = TRUE))
```

<br>

### <FONT COLOR="#004654">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_discussions_informelles <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 8, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+8, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Ile-de-France", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 3, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 3, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  filter(!is.na(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_discussions_informelles, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon leurs discussions informelles avec des clients")
```

### <FONT COLOR="#004654">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général


```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon la fréquence de leurs discussions informelles avec des clients", 1, "", "#3182bd")
```


## <FONT COLOR="#004654">Orienter vers l'aide sociale</FONT>

**Question posée dans l'enquête :** "*Vous arrive-t-il de rediriger un client vers une aide extérieure ?. A quelle fréquence cela vous arrive-t-il ?*".

### <FONT COLOR="#004654">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_redirections_aides_ext <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Ensemble des commerces", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Ile-de-France", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `A quelle fréquence cela vous arrive-t-il ?`) |> 
  filter(!is.na(`A quelle fréquence cela vous arrive-t-il ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_redirections_aides_ext, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`A quelle fréquence cela vous arrive-t-il ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon les redirections des clients vers des aides extérieures")
```

### <FONT COLOR="#004654">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`A quelle fréquence cela vous arrive-t-il ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon les redirections des clients vers des aides extérieures", 1, "", "#3182bd")
```


# ![](images/vie_quartier.png){width=11%}  <FONT COLOR="#0097B2">Vie de quartier</FONT>


## <FONT COLOR="#00A589">Renforcer l'entraide entre commerçants</FONT>

```{r}
table <- data |> 
  summarise(n=n(), .by = c(`Quelle est la catégorie de votre commerce ?`, `Faites-vous appel ou collaborez-vous avec des commerçants indépendants sans pas-de-porte fixe (exemples : un artisan n'ayant pas de local dédié, un commerçant ambulant) ?`)) |> 
  mutate(percent = round(n/sum(n)*100, 0), .by = `Quelle est la catégorie de votre commerce ?`)

ggplot(table) +
  aes(
    x = `Quelle est la catégorie de votre commerce ?`,
    y = n,
    fill = `Faites-vous appel ou collaborez-vous avec des commerçants indépendants sans pas-de-porte fixe (exemples : un artisan n'ayant pas de local dédié, un commerçant ambulant) ?`
  ) +
  geom_col() +
  scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
  labs(
    y = "Nombre de commerces",
    title = str_wrap("Collaboration avec des micro-commerçants selon la catégorie de commerce", width = 40),
    fill = "Collaboration"
  ) +
  geom_text(aes(label = paste0(percent, "%")), position = position_stack(vjust = 0.5)) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))
```

<br>


```{r}
data |> 
  summarise(n= n(), .by = c(collab_asso, aide_commercants)) |> 
  mutate(percent = paste0(round(n/sum(n)* 100, 0), "%"), .by = aide_commercants) |> 
  ggplot(aes(x=collab_asso, y=aide_commercants, fill=n)) + 
    geom_tile() +
    geom_text(aes(label = percent)) +
    theme_classic() +
    scale_fill_gradient(low = "#c7d9e8", high = "steelblue") +
    labs(
    x = "Collaboration à une association",
    y = "Aide aux commerçants",
    title = "Aide aux commerçants voisins selon la \ncollaboration avec une association",
    fill = "Aide aux commerçants") +
    custom_theme() +
    guides(fill = guide_legend(title = "Nombre de commerces"))
```

## <FONT COLOR="#00A589">Animer la rue</FONT>

## <FONT COLOR="#00A589">Contribuer à l'attractivité</FONT>



# ![](images/sante_securite.png){width=11%}  <FONT COLOR="#00A589">Santé et sécurité</FONT>



## <FONT COLOR="#00A589">Intervenir en cas d'insécurité</FONT>

**Question posée dans l'enquête :** "*A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?*".

### <FONT COLOR="#00A589">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Nouvelle fonction pour le graph avec des fréquences différentes (plus rares)
graph_questions_freq2 <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Je ne sais pas", "Jamais", "Très rarement (moins d'une fois par an)", "Rarement (1 à 2 fois par an)", "Ponctuellement (1 à 2 fois par mois)", "Régulièrement (3 à 5 fois par mois)", "Très régulièrement (plusieurs fois par semaine)"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre de commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top",
              panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
              panel.grid.major.y = ggplot2::element_blank()) +
        guides(alpha = "none") +
        coord_flip()
}

# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_intervention_insecurite <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Ensemble des commerces", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Ile-de-France", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 2, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`) |> 
  filter(!is.na(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_intervention_insecurite, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Nouvelle fonction pour le graph avec des fréquences différentes (plus rares)
graph_comparaison_pop2 <- function(data, subtitle_name){
  data |> 
    mutate(nb_reponses_freq = sum(n), .by = Var) |> 
    mutate(Var = factor(Var, levels = c("Je ne sais pas", "Jamais", "Très rarement (moins d'une fois par an)", "Rarement (1 à 2 fois par an)", "Ponctuellement (1 à 2 fois par mois)", "Régulièrement (3 à 5 fois par mois)", "Très régulièrement (plusieurs fois par semaine)")),
           categorie_population = factor(categorie_population, levels = c("faible", "moyenne", "élevée", "très élevée"))) |> 
    ggplot() + 
    geom_bar(aes(y=percent_freq, x=Var, fill = categorie_population, group = categorie_population, alpha = Var != ""),
             position="stack", stat="identity", width=.6) +
    geom_text(aes(label = paste(nb_reponses_freq, ifelse(nb_reponses_freq <= 1, "réponse", "réponses")), x=Var, fill = categorie_population, group = categorie_population, y = 0.01), 
              hjust = 0, color = "white", fontface = "italic", size = 5) +
    scale_fill_manual(values = c("faible" = "#DEEBF7", "moyenne" = "#9ECAE1", "élevée" = "#3182BD", "très élevée" = "#0C4C8A")) +
    scale_alpha_manual(values=c(1, .4)) +
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
    scale_y_continuous(labels = scales::percent, limits = c(0,1)) + # pourcentages
    labs(x = "", y = "Pourcentage des commerces", linetype = "",
         subtitle = stringr::str_wrap(subtitle_name, width = 55),
         title = stringr::str_wrap("Comparaison des communes selon leur population", width = 50)) +
    theme_classic() +
    custom_theme() +
    theme(legend.position = "top",
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank()) +
    guides(alpha = "none", fill = guide_legend(title = "Population", nrow = 2, reverse = TRUE)) +
    coord_flip()
}

# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop2(table, "Répartition des commerces selon leur intervention dans des situations d'insécurité")
```

### <FONT COLOR="#00A589">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Nouvelle fonction pour le graph avec des fréquences différentes (plus rares)
graph_type_commerce_freq_agregee2 <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Moins d'1 fois par mois", "1 fois par mois et plus"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre de commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top") +
        guides(alpha = "none")
}

# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Nouvelle fonction pour le graph avec des fréquences différentes (plus rares)
graph_type_commerce_comparaison2 <- function(data, ref_data, title_name, subtitle_name, y_n, valeur_ressortir, col_barres){
    data |> 
        left_join(ref_data, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart)), 
               percent_ref = percent_ref/100,
               .by = `Quelle est la catégorie de votre commerce ?`) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Moins d'1 fois par mois", "1 fois par mois et plus"))) |> 
        ggplot() + 
        geom_bar(aes(y=percent, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = col_barres) +
        geom_bar(aes(y=percent_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) + #axis-text trop longs sur plusieurs lignes
        scale_y_continuous(labels = scales::percent, limits = c(0,1)) + # pourcentages
        labs(x = "", y = "Pourcentage des commerces", linetype = "",
             subtitle = stringr::str_wrap(subtitle_name, width = 100),
             title = stringr::str_wrap(title_name, width = 100)) +
        facet_wrap(~`Quelle est la catégorie de votre commerce ?`) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top",
              strip.text = ggplot2::element_text(size = 15)) +
        guides(alpha = "none")
}

# Données 
table <- data |>  
  mutate(Var = str_replace_all(`A quelle fréquence intervenez-vous dans des situations d'insécurité (vols, bagarres, agressions) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison2(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon leur intervention dans des situations d'insécurité", 1, "", "#3182bd")
```




## <FONT COLOR="#00A589">Aider en cas d'incident</FONT>

**Question posée dans l'enquête :** "*Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?*".

### <FONT COLOR="#00A589">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_aide_personnes <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Ensemble des commerces", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Ile-de-France", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`) |> 
  filter(!is.na(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`)) |> 
  mutate(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` = ifelse(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?` == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", `Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`),
        percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_aide_personnes, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(Var = ifelse(Var == "Très rarement (moins d'une fois par an) ", "Très rarement (moins d'une fois par an)", Var),
         percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop2(table, "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes")
```

### <FONT COLOR="#00A589">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Un cycliste qui tombe, une personne âgée qui glisse, un accident de voiture… Ce sont des exemples de situations pouvant avoir eu lieu à proximité de votre lieu d'activité. À quelle fréquence venez-vous en aide à une personne accidentée ou ayant fait un malaise ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison2(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon l'aide aux personnes accidentées ou souffrantes", 1, "", "#3182bd")
```



## <FONT COLOR="#00A589">Veiller sur la rue</FONT>

**Question posée dans l'enquête :** "*L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?*".

### <FONT COLOR="#00A589">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_insecurite_citoyens <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Ensemble des commerces", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Ile-de-France", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`) |> 
  filter(!is.na(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq2(table, ref_insecurite_citoyens, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop2(table, "Répartition des commerces selon la confrontation à des situations d'insécurité")
```

### <FONT COLOR="#00A589">Analyse par catégorie de commerces</FONT>{.tabset}



#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee2(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`L'espace public peut être le lieu où se déroule une série de situations portant attente à la sécurité des citoyens – harcèlement de rue, vol, agression physique, sexuelle ou verbale, etc. Suite à un de ces évènements, les personnes victimes rentrent dans des commerces pour se sentir en sécurité. À quelle fréquence avez-vous affaire à ce genre de situation ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par an\\)" = "Moins d'1 fois par mois",
                                 "Rarement \\(1 à 2 fois par an\\)" = "Moins d'1 fois par mois",
                                 "Ponctuellement \\(1 à 2 fois par mois\\)" = "1 fois par mois et plus",
                                 "Régulièrement \\(3 à 5 fois par mois\\)" = "1 fois par mois et plus",
                                 "Très régulièrement \\(plusieurs fois par semaine\\)" = "1 fois par mois et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison2(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon la confrontation à des situations d'insécurité", 1, "", "#3182bd")
```

# ![](images/environnement.png){width=11%}  <FONT COLOR="#E1B441">Environnement</FONT>

## <FONT COLOR="#00A589">Réduire la consommation d'eau / d'éléctricité</FONT>

## <FONT COLOR="#00A589">Sensibiliser les clients</FONT>

## <FONT COLOR="#00A589">Réduire les déchets</FONT>

# ![](images/espace_public.png){width=11%}  <FONT COLOR="#FF5757">Espace public</FONT>


## <FONT COLOR="#FF5757">Prendre soin de l'espace public</FONT>

**Question posée dans l'enquête :** "*Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?*".

### <FONT COLOR="#FF5757">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_interpellation_mairie <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Ensemble des commerces", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 10, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+10, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Ile-de-France", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```


#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#DEEBF7")
```


#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 2, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`) |> 
  filter(!is.na(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_interpellation_mairie, "Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 3, "", "#0C4C8A")
```

#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon les interpellations des services de la mairie")
```

### <FONT COLOR="#FF5757">Analyse par catégorie de commerces</FONT>{.tabset}



#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Vous arrive-t-il d'interpeller les services techniques de la mairie suite à du matériel défectueux ou une dégradation de l'espace public environnant (exemples : lampadaire défectueux ou tags) ?`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon les interpellations des services de la mairie", 1, "", "#3182bd")
```


## <FONT COLOR="#FF5757">Assurer la propreté</FONT>

**Question posée dans l'enquête :** "*Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)*".

### <FONT COLOR="#FF5757">Analyse par taille de communes</FONT>{.tabset}

#### Général

```{r fig.height=7}
# Données de référence 
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_nettoyage_abords <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_questions_freq(table, ref_nettoyage_abords, "Ensemble des commerces", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```

#### IDF

```{r fig.height=7}
# Données de la sous-population
table <- idf |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_questions_freq(table, ref_nettoyage_abords,"En Ile-de-France, les commerçants nettoient proportionnellement plus régulièrement les abords de leur commerce que les commerçants de l'ensemble du territoire", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 2, "Très régulièrement (plusieurs fois par jour)", "#3182bd")
```

#### Population faible

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population faible") |> 
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_questions_freq(table, ref_nettoyage_abords,"Communes de moins de 1.000 habitants", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#DEEBF7")
```

#### Population moyenne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population moyenne") |> 
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_questions_freq(table, ref_nettoyage_abords,"Communes de 1.000 à 9.999 habitants", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 3, "", "#9ECAE1")
```

#### Population élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population élevée") |> 
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_questions_freq(table, ref_nettoyage_abords,"Communes de 10.000 à 99.999 habitants", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 2, "", "#3182BD")
```


#### Population très élevée

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(categorie_population == "population très élevée") |> 
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_questions_freq(table, ref_nettoyage_abords,"Communes de 100.000 habitants et plus", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 2, "", "#0C4C8A")
```


#### Comparaison

```{r fig.height=7, fig.width=8}
# Données
table <- data |>  
  mutate(categorie_population = str_remove(categorie_population, "population ")) |> 
  summarise(n = n(), .by = c(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`,
                             categorie_population)) |> 
  na.omit() |>
  rename(Var = 1) |> 
  mutate(percent_freq = n/sum(n), .by = Var) 

# On applique la fonction créée
graph_comparaison_pop(table, "Répartition des commerces selon leur soin à nettoyer les abords extérieurs")
```



### <FONT COLOR="#FF5757">Analyse par catégorie de commerces</FONT>{.tabset}


#### Général

```{r}
# Données de référence 
table <- data |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)
ref_data_freq_agregee <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Ensemble des commerces", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 15, "", "#3182bd") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+15, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```


#### Alimentaire

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Alimentaire") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces alimentaires", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

#### Equipement de la personne

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la personne") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la personne", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

#### Equipement de la maison

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Equipement de la maison") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'equipement de la maison", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

#### Culture, loisirs

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Culture, loisirs") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans la culture, les loisirs", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

#### Hygiène, santé, beauté

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Hygiène, santé, beauté") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans l'hygiène, la santé, la beauté", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

#### Services aux particuliers

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Services aux particuliers") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Commerces dans les services aux particuliers", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```



#### Café, hôtels, restaurants

```{r fig.height=7}
# Données de la sous-population
table <- data |>  
  filter(`Quelle est la catégorie de votre commerce ?` == "Café, hôtels, restaurants") |> 
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = Var) |> 
  filter(!is.na(Var)) |> 
  mutate(percent = n/sum(n)*100)

# On applique la fonction créée
graph_type_commerce_freq_agregee(table, ref_data_freq_agregee, "Café, hôtels, restaurants", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```


#### Comparaison

```{r fig.height=9, fig.width=12}
# Données 
table <- data |>  
  mutate(Var = str_replace_all(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`, 
                               c("Je ne sais pas" = NA_character_, 
                                 "Très rarement \\(moins d'une fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Rarement \\(1 à 2 fois par mois\\)" = "Moins d'1 fois par semaine",
                                 "Ponctuellement \\(1 à 2 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Régulièrement \\(3 à 5 fois par semaine\\)" = "1 fois par semaine et plus",
                                 "Très régulièrement \\(plusieurs fois par jour\\)" = "1 fois par semaine et plus"))) |> 
  summarise(n = n(), .by = c(`Quelle est la catégorie de votre commerce ?`, Var)) |> 
  filter(!is.na(Var)) |> 
  mutate(nb_reponses = sum(n),
         percent = n/sum(n),
         .by = `Quelle est la catégorie de votre commerce ?`) |> 
  mutate(`Quelle est la catégorie de votre commerce ?` = paste0(`Quelle est la catégorie de votre commerce ?`, "\n(", nb_reponses, " commerces)"))

# On applique la fonction créée
graph_type_commerce_comparaison(table, ref_data_freq_agregee, "Comparaison en % par catégorie de commerces", 
                     "Répartition des commerces selon leur soin à nettoyer les abords extérieurs", 1, "", "#3182bd")
```

## <FONT COLOR="#FF5757">Préserver le patrimoine architectural</FONT>

