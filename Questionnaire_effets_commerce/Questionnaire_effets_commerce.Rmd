---
title: "Projet EXCOM"
subtitle: "Analyse des résultats d'une enquête sur les effets du commerce de proximité "
author: "Auteur"
date: "Dernière modification le `r format(Sys.time(), '%d %B %Y')`"
output:
    rmarkdown::html_document:
      #number_sections: true
      theme: paper
      toc: true
      toc_float: true
      toc_depth: 4
      collapsed: true
      smooth_scroll: true
      css: styles.css
      includes:
        in_header: header.html
        after_body: footer.html
---

```{r setup, include=FALSE}
# Paramètres généraux
knitr::opts_chunk$set(eval = TRUE,
                      echo = FALSE,
                      fig.align = "center",
                      fig.show = "hold",
                      message = FALSE,
                      warning = FALSE,
                      collapse = TRUE,
                      results = 'asis',  # pour un dfSummary propre
                      out.width = "70%")
```

```{r logo}
# Logo Datactivist haut de page
htmltools::img(src = "https://nextcloud.datactivist.coop/s/o53wzfMNnFosQni/preview", 
               alt = 'logo', 
               style = 'position:absolute; top:0; left:0.5; padding-top:10px;') #padding=taille des espaces autour
```

# Import des données


```{r}
# Librairies
library(tidyverse)
library(readxl)
library(esquisse)
library(gt)
library(gtExtras)
library(janitor)
library(reactable)
library(plotly)
library(ggVennDiagram) #devtools::install_github("gaospecial/ggVennDiagram")
library(ggwordcloud)
library(tm)

# Données
raw_data <- read_csv("[Fillout] EXCOM _ Enquête sur les effets du commerce de proximité results.csv")
repartition_theorique <- read_excel("Repartition_theorique_repondants.xlsx")
  # identifiant des départements
departements_dg <- read_csv("https://www.data.gouv.fr/fr/datasets/r/67432189-8426-42e6-9ddb-8d21631df9c5")
  # OFGL - données de population
communes_pop <- read_delim("https://data.ofgl.fr/api/explore/v2.1/catalog/datasets/ofgl-base-communes-consolidee/exports/csv?lang=fr&refine=exer%3A%222023%22&refine=agregat%3A%22Achats%20et%20charges%20externes%22&facet=facet(name%3D%22agregat%22%2C%20disjunctive%3Dtrue)&timezone=Europe%2FBerlin&use_labels=true&delimiter=%3B", ";") |> 
  rename(cog_commune = `Code Insee 2023 Commune`,
         nom_commune = `Nom 2023 Commune`,
         population = `Population totale`) |> 
  select(cog_commune, nom_commune, population)
```

Diffusée à partir du 4 avril 2024, l'enquête sur les effets du commerce de proximité vise à rendre visible l'impact de l'activité commerciale sur le quartier, la ville et ses habitants.

Composée de près de 40 questions, l'enquête se divise en 6 sections reprenant les grandes catégories d'externalités identifiées dans la première phase du [projet de recherche-action EXCOM](https://projet-excom.fr/) :

- Lien Social ;
- Solidarités ;
- Vie de quartier ;
- Santé et Sécurité ;
- Environnement ;
- Espace public.

Au `r format(Sys.time(), '%d %B %Y')`, `r nrow(raw_data)` réponses ont été récoltées.


## Aperçu des données

```{r}
# Nom des colonnes
noms_cols <- names(raw_data) |> as.data.frame()

# Nettoyage / mise en qualité / création de nouvelles variables
data <- raw_data |> 
    # Extraction code postal de l'adresse
  rowwise() |> 
  mutate(`Quelle est l'adresse de votre commerce ?` = ifelse(`Quelle est l'adresse de votre commerce ?` == "\n  \n", NA, `Quelle est l'adresse de votre commerce ?`),
         adresses = coalesce(`Quelle est l'adresse de votre commerce ?`, 
                             as.character(`Dans quelle ville intervenez-vous le plus régulièrement ? (Renseigner le code postal)`),
                             as.character(`Dans quelle ville travaillez-vous le plus régulièrement ? (Renseigner le code postal)`)),
         adresses = str_replace_all(adresses, "\\b(\\d{2}) (\\d{3})\\b", "\\1\\2"), #formattage zip code mal renseigné
         zip_code = str_extract(adresses, "\\d{5}"),
         code_departement = substr(zip_code, 1, 2)) |> 
  left_join(departements_dg |> select(nom, COG, code_region), by = c("code_departement" = "COG")) |> 
  rename(nom_departement = nom) |> 
  mutate(nom_departement_partenaires = case_when(!code_departement %in% c("75", "76", "13", "41") ~ "Autres",
                                                 .default = nom_departement),
         code_departement_partenaires = case_when(!code_departement %in% c("75", "76", "13", "41") ~ "Autres",
                                                 .default = code_departement)) |> 
  ungroup() |> 
    # Modifications de variables existantes
  # mutate(across(everything(), ~str_replace_all(., c("Ponctuellement (1 à 2 fois par semaine)" = "1 à 2 fois par semaine",
  #                                                 "Rarement (1 à 2 fois par mois)" = "1 à 2 fois par mois",
  #                                                 "Régulièrement (3 à 5 fois par semaine)" = "3 à 5 fois par semaine",
  #                                                 "Très rarement (moins d'une fois par mois)" = "Moins d'une fois par mois",
  #                                                 "Très régulièrement (plusieurs fois par jour)" = "Plusieurs fois par jour",
  #                                                 .default = NA_character_)))) |> 
    # Création de variables catégorielles à partir des variables existantes
      ## Ce que propose le commerce
  mutate(is_services = case_when(grepl("Des services", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0"),
         is_biens_propres = case_when(grepl("Des produits fabriqués ou élaborés par moi(nous)-même(s)", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0"),
         is_biens_dautres = case_when(grepl("Des produits fabriqués ou élaborés par d'autres", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ "1",
                                 .default = "0")) |>
      ## Fréquentation du commerce
  mutate(frequentation_commerce = case_match(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`,
                                             "50 à 100" ~ "Plus de 50",
                                             "100 et 200" ~ "Plus de 50",
                                             "Plus de 200" ~ "Plus de 50",
                                             .default = `Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`)) |> 
      ## Collaboration avec des associations
  mutate(collab_asso = case_when(grepl("Oui", `Collaborez-vous avec des associations locales ? Par exemple des associations de quartier ou d'aide humanitaire.(Plusieurs réponses sont possibles)`) == TRUE ~ "Oui",
                                 `Collaborez-vous avec des associations locales ? Par exemple des associations de quartier ou d'aide humanitaire.(Plusieurs réponses sont possibles)` == "Je n'ai pas l'habitude de collaborer avec des associations" ~ "Non",
                                 .default = NA_character_)) |> 
      ## Aide aux autres commerçants
  mutate(aide_commercants = case_when(grepl("Je connais les autres commerçants mais je n'ai pas l'occasion de rendre ces services", `L'entraide entre commerçants permet de faire face à des difficultés et constitue un réseau d'échange de services. Quels services avez-vous l'habitude de rendre à vos collègues commerçants ? (Plusieurs réponses sont possibles)`) == TRUE ~ "Non",
                                      .default = "Oui")) |> 
    # Données de population
  mutate(zip_code_general = case_when(substr(zip_code, 1, 2) == "75" ~ "75056",
                                      zip_code == "13001|13002|13003|13004|13005|13006|13007|13008|13009|13010|13011|13012|13013|13014|13015|13016|13000" ~ "13055",
                                      .default = zip_code)) |> 
  left_join(communes_pop, by = c("zip_code_general" = "cog_commune")) |> 
  mutate(categorie_population = case_when(population <= median(population, na.rm = TRUE) ~ "population moyenne",
                                          population > median(population, na.rm = TRUE) ~ "population élevée",
                                          .default = NA_character_))

#data |> filter(is.na(population)) |> nrow()
#test <- data |> filter(is.na(population))



# Filtre sur l'Ile de France
idf <- data |> 
  filter(code_region == "11") # ile de france
rio::export(idf, "export_reponses_idf.csv")


# Nom des colonnes
noms_cols_data <- names(data) |> as.data.frame()
```


La répartition des réponses par type de commerce et par territoire géographique (département) est la suivante : 

```{r}
# Calcul de la répartition de notre échantillon
repartition_reelle <- data |> 
  summarise(`Échantillon réel de l'enquête` = n(), .by = code_departement_partenaires) |> 
  right_join(repartition_theorique, by = c("code_departement_partenaires" = "Code département")) |> 
  relocate(code_departement_partenaires, .after = Ville) |> 
  relocate(`Échantillon réel de l'enquête`, .after = `Échantillon théorique de l’enquête`) |> 
  arrange(code_departement_partenaires) |> 
  mutate(`Répartition des commerces français en %` = round(`Répartition des commerces français en %`, 1),
         `Échantillon théorique de l’enquête` = round(`Échantillon théorique de l’enquête`, 0),
         `Échantillon réel de l'enquête` = replace_na(`Échantillon réel de l'enquête`, 0),
         `Répartition de l'échantillon réel en %` = round(`Échantillon réel de l'enquête` / sum(`Échantillon réel de l'enquête`) * 100, 1)) |> 
  adorn_totals() |> 
  mutate(`% de l'objectif de réponses atteint` = round(`Échantillon réel de l'enquête` / `Échantillon théorique de l’enquête` * 100, 1),
         `% de l'objectif de réponses atteint` = replace_na(`% de l'objectif de réponses atteint`, 0),
         Ville = replace_na(Ville, "")) |> 
  mutate(across(-c(Ville, code_departement_partenaires), ~ if_else(Ville == "Total", round(., 0), .))) |> 
  mutate_at(vars(-`% de l'objectif de réponses atteint`), as.character) |> 
  mutate_at(vars(-`% de l'objectif de réponses atteint`), ~replace_na(., "")) 

# Affichage de la table
repartition_reelle |> 
  gt() |>
  gt_theme_nytimes() |> 
  tab_header(title = "Répartition des réponses à l'enquête selon le département") |>
  tab_style(style = list(cell_text(weight = "bold")), #en gras
    locations = cells_body(columns = `Échantillon théorique de l’enquête`)) |> 
  cols_align(align = "center", columns = everything()) |> 
  cols_align(align = "left", columns = Ville) |> 
  gt_plt_bar_pct(`% de l'objectif de réponses atteint`, scaled = TRUE, labels=TRUE, decimals = 0, #attention à remplacer les NA par 0 sinon erreur
           font_size = "14px", fill = "#FA535C", height = 20)
```

<br>

**Les départements "Autres" sont les suivants :**

```{r}
# Départements "Autres"
table <- data |> 
  filter(code_departement_partenaires == "Autres") |> 
  summarise(`Nombre de commerces` = n(), .by = nom_departement) |> 
  arrange(desc(`Nombre de commerces`)) |> 
  rename(Département = nom_departement)
reactable(table)
```



# Visualisations 

## Visualisations simples

```{r}
# Thème pour les graphs
font <- "Helvetica"
custom_theme <- function (){
    font <- "Helvetica"
    ggplot2::theme(plot.title = ggplot2::element_text(family = font,size = 21, face = "bold", color = "#222222"), 
        plot.subtitle = ggplot2::element_text(family = font,size = 18, face = "italic", margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(family = font,size = 18, margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.title = ggplot2::element_text(family = font, size = 18, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(family = font, size = 18,color = "#222222"), 
        axis.text = ggplot2::element_text(family = font, size = 15,color = "#222222"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text(family = font, size = 18,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 22, hjust = 0, face = "bold"))
}

# Premier graphique
ggplot(raw_data) +
  aes(x = `Quelle est la catégorie de votre commerce ?`) +
  geom_bar(fill = "#0C4C8A") +
  labs(
    y = "Nombre de commerces",
    title = "Catégorie des commerces répondants"
  ) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank())
```

<br>

```{r}
raw_data |> 
  mutate(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)` = 
           factor(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`,
                  levels = c("1 à 20", "20 à 50", "50 à 100", "100 et 200", "Plus de 200"))) |> 
  filter(!is.na(`Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`)) |> 
  ggplot() +
    aes(
      x = `Hors période de fêtes, quelle est la fréquentation moyenne de votre commerce par jour ? (en nombre de personnes)`
    ) +
    geom_bar(fill = "#0C4C8A") +
    labs(
      y = "Nombre de commerces", 
      x = "Fréquentation moyenne du commerce par jour",
      title = "Fréquentation des commerces répondants"
    ) +
    theme_minimal() +
    custom_theme()
```

<br>

```{r}
data |> 
  mutate(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?` = factor(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
  ggplot() +
  aes(
    x = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`
  ) +
  geom_bar(fill = "#0C4C8A") +
  labs(
    x = "Fréquence",
    y = "Nombre de commerces",
    title = str_wrap("Fréquence d'échange sur des sujets privés avec les clients", width = 45)
  ) +
  coord_flip() +
  theme_minimal() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()) +
  custom_theme()
```


<br>

```{r}
# Table
table <- data |> 
  summarise(nb= n(), .by = `Êtes-vous indépendant ?`) |> na.omit() |> 
  mutate(Pourcentage = round(nb / sum(nb) * 100, 0)) |> 
  mutate(ypos = cumsum(Pourcentage) - .9 * Pourcentage, .by = `Êtes-vous indépendant ?`)

# Dataviz
table |> 
    ggplot(aes(x="", y=nb, fill=`Êtes-vous indépendant ?`)) +  
      geom_bar(stat="identity", width=1, color="white", size = 2) +
      coord_polar("y") +
      scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
      labs(title = str_wrap("Répartition des commerces répondants selon s'ils sont indépendants ou non", width = 35)) +
      theme_classic() + 
      theme(legend.position = "top",
            strip.text.x = element_text(size = 12, face = "bold"),
            strip.background = element_blank(),
            axis.title = element_blank(),
            axis.ticks = element_blank(),
            axis.line = element_blank(),
            axis.text = element_blank(),
            legend.text = ggplot2::element_text(size = 18,color = "#222222"), 
            text = element_text(family = "Montserrat", size = 12),
            plot.title = ggplot2::element_text(size = 19, face = "bold", color = "#222222"), 
            plot.caption = ggplot2::element_text(face = "italic", size = 18, 
                                                 color = "#666666", margin = ggplot2::margin(9, 0, 9, 0)), 
            plot.title.position = "plot", 
            plot.caption.position = "plot") +
      guides(fill = guide_legend(reverse = F, title = " ")) +
      geom_text(aes(y = ypos, x = 2, label = paste(round(Pourcentage,0), "%", sep="")), color = "#333333", size=5, check_overlap = T)
```


<br>

```{r fig.width=9}
# Transformation des données pour le graph
table <- data |> 
  select(`Que propose votre commerce ? (Plusieurs réponses sont possibles)`) |> 
  mutate(id = row_number(),
         Services = case_when(grepl("Des services", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_),
         `Biens \npropres` = case_when(grepl("par moi", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_),
         `Biens d'autres` = case_when(grepl("Des produits fabriqués ou élaborés par d'autres", `Que propose votre commerce ? (Plusieurs réponses sont possibles)`) == TRUE ~ id,
                                 .default = NA_real_)) |> 
  select(Services, `Biens \npropres`, `Biens d'autres`) |> 
  as.list()

# Graph
ggVennDiagram(table, label_alpha = 0) + 
  labs(title = "Ce que vendent les commerces répondants", subtitle = " ") +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  guides(fill = guide_legend(title = "Nombre de \ncommerces")) + 
  theme(legend.position = "top",
        strip.text.x = element_text(size = 12, face = "bold"),
        strip.background = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        legend.text = ggplot2::element_text(size = 18,color = "#222222"), 
        text = element_text(family = "Montserrat", size = 12),
        plot.title = ggplot2::element_text(size = 17, face = "bold", color = "#222222"), 
        plot.caption = ggplot2::element_text(face = "italic", size = 18, 
                                             color = "#666666", margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot", 
        plot.caption.position = "plot")
```

<br>

```{r include=FALSE}
# Data
data_wordcloud <- data |> 
  filter(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)` != "Je n'ai pas l'habitude de proposer quelque chose") |> 
  mutate(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)` = str_replace_all(`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)`, ",", " ")) |> 
  glimpse()
corpus = Corpus(VectorSource(data_wordcloud$`Lorsque vous êtes sollicité par quelqu'un en situation de précarité, quel type d'aide proposez-vous ? (Plusieurs réponses sont possibles)`))
    # mise en forme des mots
corpus = tm_map(corpus, PlainTextDocument) #Conversion to Lowercase
corpus = tm_map(corpus, tolower)
corpus = tm_map(corpus, removePunctuation) #Removing Punctuation
    # retrait des mots non désirés (pronoms, auxiliaires etc.)
corpus = tm_map(corpus, removeWords, c("cloth", stopwords("french"))) #Remove stopwords
corpus = tm_map(corpus, stripWhitespace) # Eliminate white spaces
    # bon format du df
DTM <- TermDocumentMatrix(corpus)
mat <- as.matrix(DTM)
f <- sort(rowSums(mat),decreasing=TRUE) 
word_data <- data.frame(word = names(f),freq=f)
```

```{r}
# Viz
word_data |> 
  ggplot(aes(label = word, size = freq)) +
      geom_text_wordcloud(color = rep_len(c('#afc7de','#9ecae1', "#3081bc"), nrow(word_data)), family = "Montserrat") +
      scale_size_area(max_size = 18) +
      labs(title = str_wrap("Aides proposées par les commerces aux personnes en situation de précarité", width = 45)) +
      theme_minimal() +
      theme(plot.title = ggplot2::element_text(family = font,size = 21, face = "bold", color = "#222222"),
            plot.subtitle = element_text(margin = margin(t = 0, r = 0, b = -60, l = 0)))

```

<br>


## Visualisations croisées



```{r}
table <- data |> 
  summarise(n=n(), .by = c(`Quelle est la catégorie de votre commerce ?`, `Faites-vous appel ou collaborez-vous avec des commerçants indépendants sans pas-de-porte fixe (exemples : un artisan n'ayant pas de local dédié, un commerçant ambulant) ?`)) |> 
  mutate(percent = round(n/sum(n)*100, 0), .by = `Quelle est la catégorie de votre commerce ?`)

ggplot(table) +
  aes(
    x = `Quelle est la catégorie de votre commerce ?`,
    y = n,
    fill = `Faites-vous appel ou collaborez-vous avec des commerçants indépendants sans pas-de-porte fixe (exemples : un artisan n'ayant pas de local dédié, un commerçant ambulant) ?`
  ) +
  geom_col() +
  scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
  labs(
    y = "Nombre de commerces",
    title = str_wrap("Collaboration avec des micro-commerçants selon la catégorie de commerce", width = 50),
    fill = "Collaboration avec \ndes micro-commerçants"
  ) +
  geom_text(aes(label = paste0(percent, "%")), position = position_stack(vjust = 0.5)) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))
```

<br>

```{r fig.height=5}
# Stats
stats_discu_info <- data |> 
  summarise(n = n(), .by = `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  na.omit() |> 
  arrange(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)

# Data
table <- data |> 
  filter(!is.na(frequentation_commerce),
         `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)` != "Je ne sais pas") |> 
  summarise(n=n(), .by = c(frequentation_commerce, `Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`)) |> 
  mutate(percent = round(n/sum(n), 2), .by =`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`) |> 
  mutate(discu_nb_commerces = case_match(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, "Très rarement (moins d'une fois par semaine)" ~ paste0("Moins d'une fois par semaine \n(", stats_discu_info[5,2], " commerces)"), "Rarement (1 à 2 fois par mois)" ~ paste0("1 à 2 fois par mois \n(", stats_discu_info[3,2], " commerces)"), "Ponctuellement (1 à 2 fois par semaine)" ~ paste0("1 à 2 fois par semaine \n(", stats_discu_info[2,2], " commerces)"), "Régulièrement (3 à 5 fois par semaine)" ~ paste0("3 à 5 fois par semaine \n(", stats_discu_info[4,2], " commerces)"), "Très régulièrement (plusieurs fois par jour)" ~ paste0("Plusieurs fois par jour \n(", stats_discu_info[6,2], " commerces)")))

# Viz
table |> 
  #mutate(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)` = factor(`Avez-vous l'habitude de discuter avec vos clients en dehors du cadre strict de la vente ? (exemple : prendre des nouvelles personnelles)`, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
  ggplot() +
    aes(x = discu_nb_commerces, fill = frequentation_commerce, y = percent) +
    geom_col() +
    scale_fill_brewer(palette = "Blues", direction = 1) +
    scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
    labs(
      x = "Fréquence des \ndiscussions informelles",
      y = "Nombre de commerces",
      title = str_wrap("Fréquence des discussions informelles avec les clients selon le nombre de visites quotidiennes", width = 50),
      fill = "Fréquentation \ndu commerce"
    ) +
    coord_flip() +
    theme_minimal() +
    theme(
      legend.position = "top",
      axis.text.y = element_text(size = 11L),
      axis.text.x = element_text(size = 11L)
    ) +
    custom_theme() +
    theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.y = ggplot2::element_blank()) +
    guides(fill = guide_legend(nrow = 3, byrow = TRUE))
```


<br>

```{r}
data |> 
  filter(!is.na(`Utilisez-vous des techniques traditionnelles et/ou artisanales pour fabriquer vos produits ?`)) |> 
  ggplot() +
  aes(
    x = `Dans certains cas, vous pouvez être susceptible d'organiser, à l'intérieur de votre magasin, des séances d'information, démonstrations ou ateliers (explications approfondies d'utilisation de vos produits, transmission de connaissances, etc.).Combien en organisez-vous par an ? (Si vous n'en organisez aucune, mettre '0')`,
    y = `Utilisez-vous des techniques traditionnelles et/ou artisanales pour fabriquer vos produits ?`
  ) +
  geom_violin(fill = "#0C4C8A") +
  labs(
    x = "Nombre d'évènements organisés",
    y = "Utilisation de techniques \ntraditionnelles ou artisanales",
    title = str_wrap("Nombre d'évènements organisés dans le commerce selon l'utilisation de techniques traditionnelles ou artisanales", width = 45)
  ) +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank()) 
```


<br>

```{r fig.height=7, fig.width=10}
# Data
table <- data |> 
  summarise(n= n(), .by = c(nom_departement_partenaires, `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?` = factor(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) 

# Viz
table |> 
  ggplot(aes(x=nom_departement_partenaires, y=`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`, fill=n)) + 
    geom_tile() +
    theme_classic() +
    guides(fill = guide_legend(title = "Nombre de commerces", reverse = F)) +
    scale_fill_gradient(low = "#c7d9e8", high = "steelblue", 
                        limits = c(floor(min(table$n)), ceiling(max(table$n))),
                        breaks = round(seq(floor(min(table$n)), ceiling(max(table$n)), length.out = 4))) +
    labs(title = "Échange sur des sujets privés avec les clients selon le territoire", y = "Fréquence des échanges") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = 45, hjust = 1)) +
    custom_theme()
#ggplotly(graph)
```


<br>

```{r}
data |> 
  summarise(n= n(), .by = c(collab_asso, aide_commercants)) |> 
  mutate(percent = paste0(round(n/sum(n)* 100, 0), "%"), .by = aide_commercants) |> 
  ggplot(aes(x=collab_asso, y=aide_commercants, fill=n)) + 
    geom_tile() +
    geom_text(aes(label = percent)) +
    theme_classic() +
    scale_fill_gradient(low = "#c7d9e8", high = "steelblue") +
    labs(
    x = "Collaboration à une association",
    y = "Aide aux commerçants",
    title = "Aide aux commerçants voisins selon la \ncollaboration avec une association",
    fill = "Aide aux commerçants") +
    custom_theme() +
    guides(fill = guide_legend(title = "Nombre de commerces"))
```

<br>

```{r}
# Data
table <- data |> 
  mutate(`Où vendez-vous vos produits / services ?` = str_replace_all(`Où vendez-vous vos produits / services ?`, 
                                                                      c("Dans un lieu de vente à durée limitée / non fixe" = "Lieu de vente non fixe",
                                                                        "Dans un lieu de vente permanent / fixe" = "Lieu de vente fixe",
                                                                        "Je n'ai pas d'espace dédié \\(déplacements à domicile ou présence en ligne uniquement\\)" = "Pas d'espace dédié")))

# Stats
stats_lieu <- table |> 
  summarise(n = n(), .by = `Où vendez-vous vos produits / services ?`) |> 
  na.omit() |> 
  arrange(`Où vendez-vous vos produits / services ?`)

# Viz
table |> 
  filter(!is.na(`Êtes-vous indépendant ?`)) |> 
  summarise(n=n(), .by = c(`Où vendez-vous vos produits / services ?`, `Êtes-vous indépendant ?`)) |> 
  mutate(percent = round(n/sum(n), 2), .by = `Où vendez-vous vos produits / services ?`) |> 
  ggplot() +
  aes(
    x = `Où vendez-vous vos produits / services ?`,
    y = percent,
    fill = `Êtes-vous indépendant ?`
  ) +
  geom_col() +
  scale_fill_manual(values = c("Oui" = "#3182bd", "Non" = "#9ecae1")) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  labs(
    x = "Lieu de vente",
    y = "Pourcentage des commerces",
    title = "Lieu de vente des commerces selon leur \nindépendance",
    subtitle = str_wrap(paste("Répartition des commerces de l'échantillon :", stats_lieu[1,2], "en lieu fixe,", stats_lieu[2,2], "en lieu non fixe,", stats_lieu[3,2], "sans espace dédié"), width = 55),
    fill = "Indépendance"
  ) +
  coord_flip() +
  theme_minimal() +
  custom_theme() +
  theme(panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
      panel.grid.major.y = ggplot2::element_blank(),
      axis.title.y = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))
```


## Sous-populations

Les sous-populations "Population moyenne" et "Population élevée" ont été calculées à partir des données de population de 2023 :

- *population moyenne* correspond aux villes dont la population est inférieure ou égale à la médiane qui est de `r median(data$population, na.rm = T)` ;
- *population élevée* correspond aux villes dont la population est supérieure à la médiane.

### Nettoyage des abords du commerce{.tabset}

#### Général

```{r fig.height=7}
# Graphique factorisé
graph_nettoyage <- function(data, title_name, y_n, valeur_ressortir){
    data |> 
        left_join(ref_nettoyage_abords, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = "#3182bd") +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre d'utilisateurs", linetype = "",
             subtitle = stringr::str_wrap("Répartition des commerces selon leur soin à nettoyer les abords extérieurs", width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top", axis.title.x = element_blank()) +
        guides(alpha = "none") +
        coord_flip()
}

# Données de référence de balayage des abords du commerce
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_nettoyage_abords <- table |> select(-n) |> rename(percent_ref = percent)

# Données de l'ensemble
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_nettoyage(table, "Ensemble des répondants", 1, "") +
    theme(plot.caption = element_blank()) +
    geom_label(aes(x = Var, y = n+1.5, label = ifelse(is.na(percent), NA, paste0(round(percent, 0), "%"))),
               size = 5, fill = "white", label.size = NA)
```

#### IDF

```{r}
# Données de la sous-population : IdF
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# Graphique
graph_nettoyage(table, "En Ile-de-France, les commerçants nettoient proportionnellement plus régulièrement les abords de leur commerce que les commerçants de l'ensemble du territoire", 1, "Très régulièrement (plusieurs fois par jour)")

```

#### Population moyenne

#### Population élevée

```{r fig.height=7}
# Graphique factorisé
graph_nettoyage <- function(data, title_name, y_n, valeur_ressortir){
    data |> 
        left_join(ref_nettoyage_abords, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = "#3182bd") +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre d'utilisateurs", linetype = "",
             subtitle = stringr::str_wrap("Répartition des commerces selon leur soin à nettoyer les abords extérieurs", width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 45)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top", axis.title.x = element_blank()) +
        guides(alpha = "none") +
        coord_flip()
}

# Données de référence de balayage des abords du commerce
table <- data |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_nettoyage_abords <- table |> select(-n) |> rename(percent_ref = percent)

# Données de la sous-population : IdF
table <- idf |>  
  summarise(n = n(), .by = `Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`) |> 
  filter(!is.na(`Nettoyez-vous les abords extérieurs de votre commerce ? (exemples : coup de balai, ramassage de déchets)`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_nettoyage(table, "En Ile-de-France, les commerçants nettoient proportionnellement plus régulièrement les abords de leur commerce que les commerçants de l'ensemble du territoire", 1, "Très régulièrement (plusieurs fois par jour)")
```



<br>

```{r fig.height=7}
# Graphique factorisé
graph_discussions <- function(data, title_name, y_n, valeur_ressortir){
    data |> 
        left_join(ref_discussions, by = "Var") |> 
        mutate(n_ref = percent_ref/100 * sum(n),
               ecart = round((percent - percent_ref), 0),
               ecart = case_when(ecart >= 0 ~ paste0("+", ecart), .default = as.character(ecart))) |> 
        mutate(Var = factor(Var, levels = c("Jamais", "Très rarement (moins d'une fois par mois)", "Rarement (1 à 2 fois par mois)", "Ponctuellement (1 à 2 fois par semaine)", "Régulièrement (3 à 5 fois par semaine)", "Très régulièrement (plusieurs fois par jour)"))) |> 
        ggplot() + 
        geom_bar(aes(y=n, x=Var, alpha = Var != valeur_ressortir),
                 position="dodge", stat="identity", width=.6, fill = "#3182bd") +
        geom_bar(aes(y=n_ref, x=Var, linetype = "proportions de l'échantillon global"), 
                 position="dodge", stat="identity", width=.6, size = 1, fill = NA, color = "#666666") +
        scale_linetype_manual(values = c("proportions de l'échantillon global" = "dashed")) +
        scale_alpha_manual(values=c(1, .4)) +
        scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 25)) + #axis-text trop longs sur plusieurs lignes
        labs(x = "", y = "Nombre d'utilisateurs", linetype = "",
             subtitle = stringr::str_wrap("Répartition des commerces selon la fréquence des échanges sur des sujets privés avec les clients", width = 55),
             caption = "Les écarts de proportion avec l'échantillon global sont\nexprimés en points de pourcentage",
             title = stringr::str_wrap(title_name, width = 50)) +
        geom_label(aes(x = Var, y = n+y_n, label = ifelse(is.na(ecart), NA, ecart)),
                   size = 5, fill = "white", label.size = NA) +
        theme_classic() +
        custom_theme() +
        theme(legend.position = "top", axis.title.x = element_blank()) +
        guides(alpha = "none") +
        coord_flip()
}

# Données de référence de balayage des abords du commerce
table <- data |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)
ref_discussions <- table |> select(-n) |> rename(percent_ref = percent)

# Données de la sous-population : IdF
table <- idf |>  
  summarise(n = n(), .by = `Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`) |> 
  filter(!is.na(`Certaines personnes rentrent dans un magasin pour acheter un produit, mais aussi pour se sentir moins seules. Il se peut que certains de vos clients vous confient leurs problématiques personnelles. A quelle fréquence échangez-vous sur ces sujets privés ?`)) |> 
  mutate(percent = n/sum(n)*100) |> 
  rename(Var = 1)

# On applique la fonction créée
graph_discussions(table, "En Ile-de-France, les commerçants discutent moins de sujet privés avec leurs clients que les commerçants de l'ensemble du territoire", 1, "Très rarement (moins d'une fois par mois)")
```


<br>


